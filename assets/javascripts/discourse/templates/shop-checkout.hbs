
{{#let this.model.product as |p|}}
<div class="checkout-page">
  <h2>结算</h2>
  <div class="summary">
    <div>商品：{{p.title}}</div>
  </div>

  <form id="checkout-form" class="checkout-form">
    <div class="row"><label>收件人</label><input name="name" required /></div>
    <div class="row"><label>电话</label><input name="phone" required /></div>
    <div class="row"><label>国家</label><input name="country" required /></div>
    <div class="row"><label>省份</label><input name="province" required /></div>
    <div class="row"><label>城市</label><input name="city" required /></div>
    <div class="row"><label>地址</label><input name="address" required /></div>
    <div class="row"><label>邮编（选填）</label><input name="postal_code" /></div>

    <div class="row"><label>优惠券码</label><input name="coupon_code" placeholder="可选" /></div>

    <div class="row">
      <label>支付方式</label>
      <select name="payment_provider">
        <option value="wechat">微信支付</option>
        <option value="paypal">PayPal</option>
        <option value="sandbox">模拟支付</option>
      </select>
    </div>

    <button class="btn btn-primary" type="submit">提交订单并支付</button>
  </form>
</div>

<script type="module">
  import { ajax } from "discourse/lib/ajax";
  import { popupAjaxError } from "discourse/lib/ajax-error";

  const form = document.currentScript.previousElementSibling;
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = new FormData(form);
    const payProvider = data.get("payment_provider");
    try {
      const orderRes = await ajax("/shop/public/checkout", {
        type: "POST",
        data: {
          product_id: {{this.model.params.product_id}},
          variant_id: {{this.model.params.variant_id}},
          quantity: {{this.model.params.qty}} || 1,
          coupon_code: data.get("coupon_code"),
          shipping: {
            name: data.get("name"),
            phone: data.get("phone"),
            country: data.get("country"),
            province: data.get("province"),
            city: data.get("city"),
            address: data.get("address"),
            postal_code: data.get("postal_code"),
          },
          payment_provider: payProvider
        }
      });
      const orderId = orderRes.order.id;
      const payRes = await ajax("/shop/public/pay", {
        type: "POST",
        data: { order_id: orderId, payment_provider: payProvider }
      });
      if (payRes.payment?.url) {
        window.location.href = payRes.payment.url;
      } else {
        window.location.href = `/shop/complete?order_id=${orderId}`;
      }
    } catch (e2) {
      popupAjaxError(e2);
    }
  });
</script>
{{/let}}
